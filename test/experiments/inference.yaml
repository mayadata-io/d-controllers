# This is an internal job used by test suite runner
# to evaluate if desired experiments were successful
# or not
apiVersion: metacontroller.app/v1
kind: Job
metadata:
  # should match setup.yaml 
  name: inference # matches spec.test.inference.experimentName
  namespace: d-testing # matches spec.test.inference.experimentNamespace
  labels:
    d-testing.metacontroller.app/internal: "true"
spec:
  # delay start of execution by 30 seconds
  thinkTimeInSeconds: 30.0001
  # this experiment is enabled only after all other desired experiments
  # are executed & are set with status.phase
  eligible:
    checks:
    - labelSelector:
        matchLabels:
          d-testing.metacontroller.app/enabled: "true"
        matchLabelExpressions:
        - key: job.dope.metacontroller.io/phase
          operator: Exists
      when: ListCountEquals
      count: 6
  tasks:
  - name: assert-all-tests-are-completed
    assert: 
      state: 
        kind: Job
        apiVersion: metacontroller.app/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.metacontroller.app/enabled: "true"
            job.dope.metacontroller.io/phase: Completed
      stateCheck:
        stateCheckOperator: ListCountEquals
        count: 6
  - name: assert-no-tests-have-failed
    assert: 
      state: 
        kind: Job
        apiVersion: metacontroller.app/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.metacontroller.app/enabled: "true"
            job.dope.metacontroller.io/phase: Failed
      stateCheck:
        stateCheckOperator: ListCountEquals
        count: 0
  - name: assert-no-tests-have-errored
    assert: 
      state: 
        kind: Job
        apiVersion: metacontroller.app/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.metacontroller.app/enabled: "true"
            job.dope.metacontroller.io/phase: Error
      stateCheck:
        stateCheckOperator: ListCountEquals
        count: 0
---