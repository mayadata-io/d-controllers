# This is an internal job used by test suite runner
# to evaluate if desired experiments were successful
# or not
apiVersion: metacontroller.app/v1
kind: Job
metadata:
  # should match setup.yaml 
  name: inference # matches spec.test.inference.experimentName
  namespace: d-testing # matches spec.test.inference.experimentNamespace
  labels:
    d-testing.metacontroller.app/internal: "true"
spec:
  tasks:
  - name: assert-all-tests-are-completed
    assert: 
      state: 
        kind: Job
        apiVersion: metacontroller.app/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.metacontroller.app/enabled: "true"
            job.dope.metacontroller.io/phase: Completed
      stateCheck:
        stateCheckOperator: ListCountEquals
        count: 7
  - name: assert-no-tests-have-failed
    assert: 
      state: 
        kind: Job
        apiVersion: metacontroller.app/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.metacontroller.app/enabled: "true"
            job.dope.metacontroller.io/phase: Failed
      stateCheck:
        stateCheckOperator: ListCountEquals
        count: 0
  - name: assert-no-tests-have-errored
    assert: 
      state: 
        kind: Job
        apiVersion: metacontroller.app/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.metacontroller.app/enabled: "true"
            job.dope.metacontroller.io/phase: Error
      stateCheck:
        stateCheckOperator: ListCountEquals
        count: 0
---