# This is an internal recipe used by test suite runner
# to evaluate if desired experiments (read Recipes) were
# successful or not
#
# NOTE:
#   This Recipe evaluates number of successful, failed &
# errored Recipes
apiVersion: dope.mayadata.io/v1
kind: Recipe
metadata:
  name: inference
  namespace: d-testing
  labels:
    d-testing.dope.mayadata.io/internal: "true"
spec:
  # This will delay the start of execution of this Recipe based
  # on the specified time
  #
  # NOTE:
  #   This think time should be sufficient to let all 
  # experiments (read Recipes used as test cases) get executed
  #
  # NOTE:
  #   In other words, we want this Recipe to execute its tasks
  # after waiting for the specified time
  #
  # NOTE:
  #   This also implies that CI will definitely take this much 
  # time to decide the result of the CI run
  thinkTimeInSeconds: 20.0001
  # This Recipe is eligible to run only when the checks succeed
  #
  # NOTE:
  #   In this case, this Recipe will be eligible only after the
  # number of Recipes with matching labels equal the given count
  #
  # NOTE:
  #   Eligibility check will get triggered after above think time 
  # has elapsed
  eligible:
    checks:
    - labelSelector:
        matchLabels:
          d-testing.dope.mayadata.io/inference: "true"
        matchLabelExpressions:
        - key: recipe.dope.mayadata.io/phase
          operator: Exists
      when: ListCountEquals
      count: 10
  tasks:
  # Start with asserting the count of Recipes that should 
  # complete successfully
  - name: assert-count-of-tests-that-completed
    assert: 
      state: 
        kind: Recipe
        apiVersion: dope.mayadata.io/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.dope.mayadata.io/inference: "true"
            recipe.dope.mayadata.io/phase: Completed
      stateCheck:
        stateCheckOperator: ListCountEquals
        # These many Recipes should succeed
        count: 8
  # Then assert the count of Recipes that should fail
  - name: assert-count-of-tests-that-failed
    assert: 
      state: 
        kind: Recipe
        apiVersion: dope.mayadata.io/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.dope.mayadata.io/inference: "true"
            recipe.dope.mayadata.io/phase: Failed
      stateCheck:
        stateCheckOperator: ListCountEquals
        # These many Recipes should fail
        count: 2
  # Then assert the count of Recipes that should error
  - name: assert-count-of-tests-that-errored
    assert: 
      state: 
        kind: Recipe
        apiVersion: dope.mayadata.io/v1
        metadata:
          namespace: d-testing
          labels:
            d-testing.dope.mayadata.io/inference: "true"
            recipe.dope.mayadata.io/phase: Error
      stateCheck:
        stateCheckOperator: ListCountEquals
        # These many Recipes should error out
        count: 0
---